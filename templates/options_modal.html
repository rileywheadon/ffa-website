{% macro optionsDropdown(title, items) %}

<div 
	class="flex flex-col border border-gray-300 rounded-lg"
	x-data="{ open : false }"
>
	<div 
		class="flex flex-row items-center px-4 py-2 hover:bg-gray-100 text-md"
		x-bind:class="open ? 'rounded-t-lg bg-gray-100 border-b border-gray-300' : 'rounded-lg'"
		x-on:click="open = !open"
	>
		<div class="grow">{{ title }}</div>
		<div class="text-xl" x-text="open ? '&#8964;' : '&#8250;'"></div>
	</div>
	<div class="p-4 flex flex-col gap-y-4"x-bind:class="open ? '' : 'hidden'">

		{% for item in items %}

			{% if not item.choices %} 

				{% if options[item.key] is sequence %}
					{% set value = options[item.key] | join(", ") %}
				{% else %}
					{% set value = options[item.key] %}
				{% endif %}

				<div>
					<span class="font-semibold">{{ item.name }}</span>:
					<input 
						class="border border-gray-300 rounded-md px-1" 
						name="{{ item.key }}"
						value="{{ value }}"
						type="text"
					/>
				</div>
				<p>{{ item.description }}</p>

			{% else %}

				<div>
					<span class="font-semibold">{{ item.name }}</span>:
					<select 
						name="{{ item.key }}"
						class="border border-gray-300 rounded-md text-sm py-1 px-2 bg-white"
					>
						{% for choice in item.choices %}
							<option 
								value="{{ choice }}"
								{% if options[item.key] == choice %}selected{% endif %}
							>
								{{ choice }}
							</option>
						{% endfor %}
					</select>
				</div>
				<p>{{ item.description }}</p>

			{% endif %}
		{% endfor %}

	</div>
</div>

{% endmacro %}

<div 
  class="fixed inset-0 z-50 flex items-center justify-center backdrop-blur-md bg-white/50 backdrop-brightness-50"
  @click.self="document.getElementById('modal-container').innerHTML = ''; loading = false;"
>

  <form 
		method="POST"
		action="/save-options"
		class="bg-white p-6 rounded-lg shadow-xl w-[90%] max-w-2xl h-[80%] flex flex-col min-h-0"
	>

		<div class="mb-6"><h2 class="text-xl font-semibold">Options</h2></div>

		<div class="grow flex flex-col gap-y-2 overflow-y-auto text-sm">

			{{ optionsDropdown(
				"Exploratory Data Analysis", 
				[
					{
						"name": "Significance Level",
						"key": "significance_level",
						"description": "The threshold for statistical significance used by change point detection and trend detection tests. Must be between 0.01 and 0.1."
					}, 
					{
						"name": "BBMK Samples",
						"key": "bbmk_samples",
						"description": "The number of bootstrap samples generated by the Block-Bootstrap Mann-Kendall test. Must be a postive integer."
					}, 

				]
			) }}

			{{ optionsDropdown(
				"Distribution Selection", 
				[
					{
						"name": "Selection Method",
						"key": "selection_method",
						"choices": ["L-distance", "L-kurtosis", "Z-statistic"],
						"description": "The metric (based on L-moments) used to select a probability distribution."
					}, 
					{
						"name": "Z-statistic Samples",
						"key": "z_samples",
						"description": "The number of samples used to compute the Z-statistic selection metric."
					}, 

				]
			) }}

			{{ optionsDropdown(
				"Parameter Estimation", 
				[
					{
						"name": "Stationary Estimation Method",
						"key": "s_estimation",
						"choices": ["L-moments", "MLE", "GMLE"],
						"description": "The parameter estimation method used for stationary models."
					}, 
					{
						"name": "Nonstationary Estimation Method",
						"key": "ns_estimation",
						"choices": ["MLE", "GMLE"],
						"description": "The parameter estimation method used for nonstationary models."
					}, 
					{
						"name": "GEV Prior Parameters",
						"key": "gev_prior",
						"description": "Parameters used to define the Beta prior on the GEV distribution for GMLE parameter estimation. Must be two positive numbers separated by a comma."
					}, 

				]
			) }}

			{{ optionsDropdown(
				"Uncertainty Quantification", 
				[
					{
						"name": "Stationary Uncertainty Quantification Method",
						"key": "s_uncertainty",
						"choices": ["Bootstrap", "RFPL", "RFGPl"],
						"description": "The uncertainty quantification method used for stationary models."
					}, 
					{
						"name": "Nonstationary Uncertainty Quantification Method",
						"key": "ns_uncertainty",
						"choices": ["Bootstrap", "RFPL", "RFGPl"],
						"description": "The uncertainty quantification method used for nonstationary models."
					}, 
					{
						"name": "Return Periods",
						"key": "return_periods",
						"description": "The return periods (in years) at which to estimate return levels. Must be a list of positive integers in increasing order separated by commas."
					}, 
					{
						"name": "Parametric Bootstrap Samples",
						"key": "bootstrap_samples",
						"description": "The number of samples used for the bootstrap uncertainty quantification method. Must be a positive integer."
					}, 
					{
						"name": "RFPL/RFGPL Tolerance",
						"key": "rfpl_tolerance",
						"description": "The log-likelihood tolerance used for the RFPL and RFGPL uncertainty quantification methods. Must be positive."
					}
				]
			) }}

			{{ optionsDropdown(
				"Model Assessment", 
				[
					{
						"name": "Plotting Position Formula",
						"key": "pp_formula",
						"choices": ["Weibull", "Blom", "Cunnane", "Gringorten", "Hazen"],
						"description": "The plotting position formula used for model assessment."
					}, 
				]
			) }}

		</div>

		<div class="w-full flex flex-row justify-end mt-6"> 
			<button type="submit" class="rounded-lg bg-sky-600 text-white px-4 py-2">
				<span class="font-semibold text-sm">Save Changes</span>
			</button>
		</div>

	</form>
</div>
