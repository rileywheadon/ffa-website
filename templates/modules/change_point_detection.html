{% extends "module.html" %}

{% from "macros.html" import resultItem %}
{% from "status_bar.html" import statusBar %}
{% from "control_bar.html" import controlBar %}

{% block status %} 
	{{ statusBar(2) }} 
{% endblock %}

{% set period = results["period"] %} 
{% set pettitt = results["items"]["pettitt"] %} 
{% set mks = results["items"]["mks"] %} 
{% set change_year = pettitt["change_year"] %}
{% set change_years = mks["change_df"] | map(attribute = "year") %} 

{% block module_left %} 

<div class="flex flex-col w-full h-full gap-y-2">
	{{ resultItem("pettitt", pettitt, period, options) }}
	{{ resultItem("mks", mks, period, options) }}
</div>

{% endblock %}

{% block module_right %} 

<div class="p-4 border border-gray-300 rounded-lg flex flex-col gap-y-2">

	<div class="flex-none w-full text-center underline">Module Summary</div>

	<p>A change point is an abrupt shift or temporal pattern switch (e.g. beginning of a trend) in a time series. Change points indicate inhomogeneous periods, meaning a single model may not represent the entire record adequately. Instead, piecewise analysis should be applied to each homogeneous subperiod. <i>Always use case-specific knowledge about the station if possible.</i></p>

</div>

<div class="grow p-4 border border-gray-300 rounded-lg flex flex-col gap-y-2">

	<div class="flex-none w-full text-center underline">Select Split Points</div>

	<div> 

		{% if pettitt.reject or mks.reject %} 
			<p>The split points detected during EDA are listed below:</p>
			<ul class="list-disc list-inside mt-2">
				{% if pettitt.reject %}
					<li>
						{{ change_year }} 
						(from Pettitt test, <i>p={{ pettitt.p_value }}</i>)
					</li>
				{% endif %}
				{% for year in change_years %}
					<li>
						{{ year }} 
						(from MKS test <i>p={{ mks.p_value }}</i>)
					</li>
				{% endfor %}
			</ul>
		{% else %}
			<p>No split points were detected during EDA.</p>
		{% endif %}

	</div>

	<form
		method="POST"
		action="/trend-detection"
		id="change-point-detection"
	>
		Enter zero or more split points for trend detection as a comma-separated list of years:
		<input 
			class="border-2 border-sky-600 ml-1 w-40 rounded-md px-1" 
			type="text" 
			name="splits"
		/>
	</form>

</div>

{% endblock %}

{% block controls %}
	{{ controlBar("change-point-detection", "trend-detection", True) }}
{% endblock %}
